<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="shared-styles.html">

<dom-module id="smart-thermostat">
    <template>
        <style include="iron-flex iron-flex-alignment shared-styles">
            paper-input {
                padding-right: 4px;
            }

            paper-button {
                height: 40px;
                float: right;
                margin-right: 0px;
            }

            iron-icon {
                padding-top: 24px;
                padding-bottom: 24px;
                width: 128px;
                height: 128px;
            }

            .card {
                height: 390px;
                width: 300px;
            }

            #button-bar {
                margin-bottom: 8px;
            }

            #thermostat {
                margin-right: 36px;
            }

            #ambient {
                /* Get ambient input field to fit inside circle */
                width: 50px;
                margin-left: 25px;
            }

        </style>

        <div class="card">
            <div id="button-bar" class="layout horizontal justified">
                <div id="thermostat-id" class="circle">[[thermostat.id]]</div>
                <div class="flex"></div>
                <paper-icon-button id="cloud" icon="cloud-off" on-tap="_handleCloud"></paper-icon-button>
                <paper-icon-button icon="delete" on-tap="_handleDelete"></paper-icon-button>
            </div>

            <div class="layout horizontal center-justified">
                <strong>Setpoint</strong>
                <!-- Set potential setpoints to 60F (15C) - 83F (28C) -->
                <paper-slider id="setpoint" title="Set Point" editable="true"
                    value="[[thermostat.states.thermostatTemperatureSetpoint]]"
                    on-value-change="_handleSetpoint"
                    min="15" max="28"></paper-slider>
            </div>

            <!-- thermostat icon -->
            <div class="layout horizontal center-justified">
                <div id="thermostat" class="main-circle">
                    <img src="../images/thermometer-512.png" width="45" height="45"/>
                    <paper-input
                        id="ambient"
                        label="Current"
                        value="[[thermostat.states.thermostatTemperatureAmbient]]"
                        on-input="_handleAmbient"
                        auto-validate pattern="[0-9]+[.]?[0-9]*">
                        <div suffix>ÂºC</div>
                    </paper-input>
                </div>
                <div class="layout vertical center-justified">
                    <div>Mode:<br/><b>[[thermostat.states.thermostatMode]]</b>
                    </div>
                </div>
            </div>

            <!-- controls -->
            <paper-input id="nickname" label="Nickname" value$="{{thermostat.properties.name.nicknames.0}}"></paper-input>
            <paper-input id="name" label="Name" value$="{{thermostat.properties.name.name}}"></paper-input>
            <div>Default Name: {{thermostat.properties.name.defaultNames.0}}</div>
        </div>
    </template>

    <script>
        class SmartThermostat extends Polymer.Element {
            static get is() { return 'smart-thermostat' }

            static get properties() {
                return {
                    thermostat: {
                        type: Object,
                        observer: '_thermostatChanged'
                    }
                }
            }

            constructor() {
                super();
                this._initialized = false;
            }

            initialize() {
                window.requestAnimationFrame(() => {
                    if (!this.light || this._initialized) {
                        return;
                    }
                    this._initialized = true;
                    this.$.nickname.addEventListener('keydown', this._handleNameOrNicknameChange.bind(this));
                    this.$.nickname.addEventListener('blur', this._execNameOrNicknameChange.bind(this));
                    this.$.name.addEventListener('keydown', this._handleNameOrNicknameChange.bind(this));
                    this.$.name.addEventListener('blur', this._execNameOrNicknameChange.bind(this));

                    this._handleRegister();
                });
            }

            _handleSetpoint() {
                this.async(() => {
                    this.thermostat.states.thermostatTemperatureSetpoint =
                        this.$.setpoint.value;
                    this._notifyStateChange();
                });
            }

            _handleAmbient() {
                this.async(() => {
                    this.thermostat.states.thermostatTemperatureAmbient =
                        parseFloat(this.$.ambient.value);
                    this._notifyStateChange();
                });
            }

            _handleCloud() {
                // Toggle online state on button press.
                this.thermostat.states.online = !this.thermostat.states.online;
                this._handleRegister();
                this._changeEventSource();
            }

            _handleRegister() {
                // Register source if undefined
                if (!this._source) {
                    this._source = new EventSource(SMART_HOME_PROVIDER_CLOUD_ENDPOINT + '/device-connection/' + this.thermostat.id);
                }
                this._callSmartHomeProviderCloud('/register-device', 'POST', this.thermostat)
                    .then(this._changeEventSource.bind(this))
                    .catch(function (error) {
                        console.log('>>> failed to register device with Smart Home Provider cloud:', error);
                    });
            }

            _handleDelete() {
                this._callSmartHomeProviderCloud('/remove-device', 'POST', this.thermostat)
                    .then(this._changeEventSource.bind(this))
                    .catch(function (error) {
                        console.log('>>> failed to remove device with Smart Home Provider Cloud:', error);
                    });
                if (this._source) this._source.close();

                const app = document.querySelector('my-app');
                const thermostats = app.thermostats;
                for (var i = 0; i < thermostats.length; i++) {
                    if (thermostats[i].id == this.thermostat.id) {
                        app.removeDevice('thermostats', i);
                    }
                }
            }

            _execNameOrNicknameChange(event) {
                if (event.target.id == 'nickname') {
                    this.thermostat.properties.name.nicknames[0] = event.target.value;
                }
                else if (event.target.id == 'name') {
                    this.thermostat.properties.name.name = event.target.value;
                }
                this._notifyStateChange(true);
            }

            _handleNameOrNicknameChange(event) {
                if (event.which == ENTERKEY) this.blur();
            }

            _callSmartHomeProviderCloud(path, method, opt_body) {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + AUTH_TOKEN
                    }
                };

                if (opt_body) options.body = JSON.stringify(opt_body);
                return fetch(SMART_HOME_PROVIDER_CLOUD_ENDPOINT + path, options);
            }

            _changeEventSource() {
                if (!this.thermostat.states.online) {
                    // going offline
                    this._source.close();
                } else {
                    // going online
                    this._source = new EventSource(SMART_HOME_PROVIDER_CLOUD_ENDPOINT + '/device-connection/' + this.thermostat.id);
                    this._source.addEventListener('change', function (e) {
                        this._changeState(JSON.parse(e.data));
                    }.bind(this));
                    this._source.addEventListener('pullUp', function (e) {
                        this._exec();
                    }.bind(this));
                    this._source.addEventListener('error', function (error) {
                        if (error.eventPhase == 2) {
                            console.log('>>> event source closed');
                            setTimeout(this._changeEventSource.bind(this), 5000);
                            return;
                        } else {
                            console.error('>>> error in event source:', error);
                        }
                    }.bind(this));
                }
                this._notifyStateChange();
            }

            _changeState(changes) {
                changes.thermostatTemperatureSetpoint = parseFloat(changes.thermostatTemperatureSetpoint).toFixed(1);
                for (var name in changes) {
                    const value = changes[name];
                    this.set('thermostat.states.' + name, value);
                }
                this._notifyStateChange();
            }

            _notifyStateChange(isNameChange) {
                this._thermostatChanged();
                if (this.thermostat.states.online) this._exec(isNameChange);
            }

            _thermostatChanged() {
                if (!this._initialized) {
                    this.initialize();
                }

                const app = document.querySelector('my-app');
                app.showToast(`${this.thermostat.properties.name.nicknames[0]} state changed`);

                this.$.cloud.icon = this.thermostat.states.online ? 'cloud' : 'cloud-off';
                if (this.thermostat.states.thermostatMode
                    && this.thermostat.states.thermostatTemperatureSetPoint
                    && this.thermostat.states.thermostatTemperatureAmbient
                    && this.thermostat.states.thermostatHumidityAmbient) {
                    console.log('updated thermostat');
                } else {
                    console.log('failed to update thermostat');
                }
            }

            _exec(isNameChange) {
                this.thermostat.nameChanged = isNameChange ? true : false;
                this._callSmartHomeProviderCloud('/exec', 'POST', this.thermostat).then(function () {
                    console.log('>>> exec to Smart Home Provider Cloud');
                }).catch(function (error) {
                    console.log('>>> failed to exec to Smart Home Provider Cloud:', error);
                });
            }
        }
        customElements.define(SmartThermostat.is, SmartThermostat);
    </script>
</dom-module>
